name: infra-destroy
on: { workflow_dispatch: {} }

jobs:
  destroy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GOOGLE_REGION: us-central1
      GOOGLE_ZONE: us-central1-a
    steps:
    - uses: actions/checkout@v4

    - uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        version: '>= 488.0.0'

    - uses: hashicorp/setup-terraform@v3

    # Debug: confirm files are present
    - name: Show repo tree
      run: |
        pwd
        ls -la
        ls -la terraform
        sed -n '1,120p' terraform/backend.tf || true

    - name: Terraform Init (GCS backend, reconfigure)
      run: terraform -chdir=terraform init -input=false -reconfigure

    - name: Terraform Destroy
      run: |
        terraform -chdir=terraform destroy -auto-approve \
          -var "project_id=${GOOGLE_PROJECT_ID}" \
          -var "region=${GOOGLE_REGION}" \
          -var "zone=${GOOGLE_ZONE}"

