name: deploy-app
on:
  workflow_dispatch:
  push:
    paths: ["k8s/**", "scripts/k8s_*.sh", ".github/workflows/deploy_app.yaml"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GOOGLE_ZONE: us-central1-a
    steps:
    - uses: actions/checkout@v4

    - uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # Install gke auth plugin (+ kubectl) via setup-gcloud
    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        version: '>= 488.0.0'
        install_components: true
        components: gke-gcloud-auth-plugin kubectl   # <-- important

    - name: Enable kubectl to use the plugin
      run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> "$GITHUB_ENV"

    - name: Get cluster credentials
      run: gcloud container clusters get-credentials test-cluster --zone "${GOOGLE_ZONE}" --project "${GOOGLE_PROJECT_ID}"

    # (optional) sanity checks
    - name: Check tooling
      run: |
        kubectl version --client
        gcloud components list | grep -E 'gke-gcloud-auth-plugin.*Installed' || true

    - name: Deploy core (Pod + NEG Service + Ingress)
      run: bash scripts/k8s_apply_core.sh

    - name: Deploy probe demos
      run: bash scripts/k8s_probe_demos.sh

    - name: Deploy Locust
      run: bash scripts/k8s_locust_apply.sh

    - name: Switch to Deployment + PDB
      run: bash scripts/k8s_switch_to_deploy.sh

